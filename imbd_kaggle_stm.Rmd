---
title: "imdb_kaggle"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(quanteda)
library(ggplot2)
library(ggrepel)
library(quanteda.textmodels)
theme_set(theme_minimal())
library(stm) # NOTE: You might need to install this
require(quanteda)
require(quanteda.corpora)
library(igraph)# NOTE: You might need to install this
```

## Kaggle Data

```{r}
dat<-read.csv("imdb_1972-2019.csv")

# Exploring the dataset
names(dat)

# Selecting the variables we are going to use and remove duplicates
dat1 <- dat %>% 
  select(Title, Year, Rating, Metascore, Description, Genre, Runtime..Minutes., Revenue..Millions.) %>% 
  distinct(Title, .keep_all = TRUE)
names(dat1)

# If you want to look at the duplicates 
dat %>% filter(duplicated(.[["Title"]]))
dat1 %>% filter(duplicated(.[["Title"]])) # to test that filter worked

# convert factors to character columns
dat2 <- dat1 %>%
  mutate_if(is.factor, as.character)

sapply(dat2, class) # to see current classes


###################################
# recreate corpus initialization for scraped data (perhaps move to different script later)

total<-read.xlsx("scraped_data.xlsx")
names(total) # this needs to pull from the scrapped data set
sapply(total, class) # to see current classes

# select cols to keep and remove duplicates
# COME BACK TO LATER TO KEEP MORE COLS- will be useful for model
dat2020 <- total %>% 
  select(Title, Year, Rating, Description) %>% 
  distinct(Title, .keep_all = TRUE)
names(dat2020)

# If you want to look at the duplicates 
total %>% filter(duplicated(.[["Title"]]))
dat2020 %>% filter(duplicated(.[["Title"]])) # to test that filter worked

# convert factors to character columns  ### come back to - shouldn't apply factorization to rating or year
dat2020 <- dat2020 %>%
  mutate_if(is.factor, as.character)

sapply(dat2020, class) # to see current classes
dat2020 <- na.omit(dat2020) #remove films missing description
```

## Structural Topic Model


```{r}
# initialize corpus and dfm objects

# Turn kaggle data into corpus
corp1 <- corpus(dat2, 
       text_field = "Description",
       docid_field = "Title")

docvars(corp1, "Title") <- dat1$Title ## Add back Title

# Create a document-feature matrix to enable text analysis
#With no word limits we get 15.003 columns (so possible variables)
corp_dfm <- dfm(corp1, 
                remove_punct = TRUE, 
                remove_numbers = TRUE,
                remove_symbol = TRUE, 
                remove_separators = TRUE,
                split_hyphens = TRUE,
                remove = stopwords("en")) #%>%
  #dfm_trim(min_termfreq = 0.8, termfreq_type = "quantile") 
  # only keeps top 5% of words - play around with (no doc limit)

######### Scraped Data ################
  
# make corpus from scraped 2020 imdb data
corp_2020 <- corpus(dat2020, 
       text_field = "Description",
       docid_field = "Title")

docvars(corp_2020, "Title") <- dat2020$Title ## Add back Title

# make scrapped corpus into dfm 
corp_2020_dfm <- dfm(corp_2020,
                remove_punct = TRUE,
                remove_symbols = TRUE,
                remove_separators = TRUE,
                split_hyphens = TRUE,
                remove_numbers = TRUE,   
                remove = stopwords("en")) 

```

```{r}
#STM

# build topic model from kaggle data
corp_dfm_stm <- asSTMCorpus(corp_dfm)
mod <- stm(documents = corp_dfm_stm$documents, vocab = corp_dfm_stm$vocab,
           K = 10, data = corp_dfm_stm$data,
           seed = 12345)

plot(topicCorr(mod))

topicQuality(mod, documents = corp_dfm_stm$documents)
dim(mod$beta$logbeta[[1]])

# name the topics
labels <- apply(sageLabels(mod)$marginal$frex, 1,
                function(x){ paste(x[1:4], collapse = "-") })

# make dfm into STM corpus
new_docs <- asSTMCorpus(corp_2020_dfm) ## This is where films are dropped if na.omit not run (above)

# apply old topic model
new_stm <- alignCorpus(new_docs,
                       old.vocab = corp_dfm_stm$vocab)

nds <- fitNewDocuments(mod, documents = new_stm$documents,
                newData = new_stm$data)

thetas <- data.frame(nds$theta)
colnames(thetas) <- labels
rownames(thetas) <- paste(docvars(corp_2020_dfm)$Title)

# next step: link this spreadsheet (thetas by topic) to 2020 film data to create model

#probably not useful but cute!
library(ca)
plot(ca(thetas))

```

